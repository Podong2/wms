<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.wisestone.wms.domain.Project">

    <resultMap id="projectManagedAttachedFileResultMap" type="kr.wisestone.wms.web.rest.dto.ProjectManagedAttachedFileDTO">
        <result property="location" column="location"/>
        <result property="locationType" column="locationType"/>
        <result property="locationId" column="locationId"/>
        <result property="attachedFile.id" column="attachedFileId"/>
        <result property="attachedFile.name" column="attachedFileName"/>
        <result property="attachedFile.size" column="attachedFileSize"/>
        <result property="attachedFile.contentType" column="attachedFileContentType"/>
        <result property="attachedFile.createdBy" column="attachedFileCreatedBy"/>
        <result property="attachedFile.createdDate" column="attachedFileCreatedDate"/>
        <result property="attachedFile.lastModifiedBy" column="attachedFileLastModifiedBy"/>
        <result property="attachedFile.lastModifiedDate" column="attachedFileLastModifiedDate"/>
    </resultMap>

    <resultMap id="projectDetailResultMap" type="kr.wisestone.wms.web.rest.dto.ProjectDTO">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="contents" column="contents"/>
        <result property="statusId" column="statusId"/>
        <result property="statusName" column="statusName"/>
        <result property="startDate" column="startDate"/>
        <result property="endDate" column="endDate"/>
        <result property="folderYn" column="templateYn"/>
        <result property="createdBy" column="createdBy"/>
        <result property="createdByName" column="createdByName"/>
        <result property="createdDate" column="createdDate"/>
        <result property="lastModifiedBy" column="lastModifiedBy"/>
        <result property="lastModifiedDate" column="lastModifiedDate"/>
        <collection property="projectParents" select="getParentProject" column="id" javaType="kr.wisestone.wms.web.rest.dto.ProjectDTO" />
        <collection property="attachedFiles" javaType="java.util.ArrayList" resultMap="attachedFileResultMap"/>
        <collection property="projectAdmins" select="getProjectAdmins" column="id" javaType="java.util.ArrayList" ofType="kr.wisestone.wms.web.rest.dto.UserDTO"/>
        <collection property="projectWatchers" select="getProjectWatchers" column="id" javaType="java.util.ArrayList" ofType="kr.wisestone.wms.web.rest.dto.UserDTO"/>
        <collection property="projectMembers" select="getProjectMembers" column="id" javaType="java.util.ArrayList" ofType="kr.wisestone.wms.web.rest.dto.TaskDTO"/>
    </resultMap>

    <resultMap id="attachedFileResultMap" type="kr.wisestone.wms.web.rest.dto.AttachedFileDTO">
        <id property="id" column="attachedFileId" />
        <result property="name" column="attachedFileName"/>
        <result property="size" column="attachedFileSize"/>
        <result property="contentType" column="attachedFileContentType"/>
    </resultMap>

    <resultMap id="userResultMap" type="kr.wisestone.wms.web.rest.dto.UserDTO">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="login" column="login"/>
        <result property="profileImageId" column="profileImageId"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
    </resultMap>

    <resultMap id="projectResultMap" type="kr.wisestone.wms.web.rest.dto.ProjectDTO">
        <id property="id" column="id" />
        <result property="name" column="name"/>
        <result property="folderYn" column="folderYn"/>
        <result property="createdBy" column="createdBy"/>
        <result property="createdDate" column="createdDate"/>
        <result property="lastModifiedBy" column="lastModifiedBy"/>
        <result property="lastModifiedDate" column="lastModifiedDate"/>
    </resultMap>

    <select id="getProjectAdmins" resultMap="userResultMap">
        SELECT u.id as id, u.name as name, u.profile_image_id as profileImageId, u.phone as phone, u.email as email, u.login as login
            , u.created_by as createdBy, u.created_date as createdDate
            , u.last_modified_by as lastModifiedBy, u.last_modified_date as lastModifiedDate
        FROM owl_user u
            INNER JOIN owl_project_user pu ON u.id = pu.user_id AND pu.project_id = #{id} and pu.user_type = 'ADMIN'
        ORDER BY pu.id ASC
    </select>

    <select id="getProjectWatchers" resultMap="userResultMap">
        SELECT u.id as id, u.name as name, u.profile_image_id as profileImageId, u.phone as phone, u.email as email, u.login as login
            , u.created_by as createdBy, u.created_date as createdDate
            , u.last_modified_by as lastModifiedBy, u.last_modified_date as lastModifiedDate
        FROM owl_user u
            INNER JOIN owl_project_user pu ON u.id = pu.user_id AND pu.project_id = #{id} and pu.user_type = 'WATCHER'
        ORDER BY pu.id ASC
    </select>

    <select id="getProjectMembers" resultMap="userResultMap">
        SELECT u.id as id, u.name as name, u.profile_image_id as profileImageId, u.phone as phone, u.email as email, u.login as login
            , u.created_by as createdBy, u.created_date as createdDate
            , u.last_modified_by as lastModifiedBy, u.last_modified_date as lastModifiedDate
        FROM owl_user u
            INNER JOIN owl_project_user pu ON u.id = pu.user_id AND pu.project_id = #{id} and pu.user_type = 'MEMBER'
        ORDER BY pu.id DESC
    </select>

    <select id="getParentProject" resultMap="projectResultMap">
        SELECT p.id as id, p.name as name
            , CASE
                WHEN p.folder_yn = 'Y' THEN true
                WHEN p.folder_yn = 'N' THEN false
              END as folderYn
            , p.created_by as createdBy, p.created_date as createdDate
            , p.last_modified_by as lastModifiedBy, p.last_modified_date as lastModifiedDate
        FROM owl_project p
        WHERE p.id IN (SELECT pr.parent_id FROM owl_project_relation pr WHERE pr.child_id = #{id})
    </select>

    <select id="getProject" resultType="kr.wisestone.wms.web.rest.dto.ProjectDTO" resultMap="projectDetailResultMap" parameterType="java.lang.Long">
        SELECT p.id as id, p.name as name, p.start_date as startDate, p.end_date as endDate
            , CASE
                WHEN p.folder_yn = 'Y' THEN true
                WHEN p.folder_yn = 'N' THEN false
            END as folderYn
            , pc.id as statusId, pc.name as statusName
            , af.id as attachedFileId, af.name as attachedFileName
            , af.size as attachedFileSize, af.content_type as attachedFileContentType
            , p.created_by as createdBy, (SELECT name FROM owl_user cu WHERE cu.login = p.created_by) as createdByName, p.created_date as createdDate
            , p.last_modified_by as lastModifiedBy, p.last_modified_date as lastModifiedDate
        FROM owl_project p
            LEFT JOIN owl_code pc ON p.status_id = pc.id
            LEFT OUTER JOIN owl_project_attached_file paf ON paf.project_id = p.id
            LEFT JOIN owl_attached_file af ON paf.attached_file_id = af.id
        WHERE p.id = #{id}
    </select>

    <select id="getProjectManagedAttachedFile" resultType="java.util.ArrayList" resultMap="projectManagedAttachedFileResultMap" parameterType="java.util.HashMap">
        SELECT p.name as location, 'PROJECT' as locationType, p.id as locationId
            , af.id as attachedFileId, af.name as attachedFileName
            , af.size as attachedFileSize, af.content_type as attachedFileContentType
            , af.created_by as attachedFileCreatedBy, af.created_date as attachedFileCreatedDate
            , af.last_modified_by as attachedFileLastModifiedBy, af.last_modified_date as attachedFileLastModifiedDate
        FROM owl_project p
            RIGHT JOIN owl_project_attached_file paf ON p.id = paf.project_id
            LEFT JOIN owl_attached_file af ON paf.attached_file_id = af.id
        WHERE 1=1
        <if test="projectIds != null">
            AND p.id IN
            <foreach item="item" index="index" collection="projectIds"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        UNION ALL
        SELECT p.name as location, 'PROJECT_SHARED' as locationType, p.id as locationId
            , af.id as attachedFileId, af.name as attachedFileName
            , af.size as attachedFileSize, af.content_type as attachedFileContentType
            , af.created_by as attachedFileCreatedBy, af.created_date as attachedFileCreatedDate
            , af.last_modified_by as attachedFileLastModifiedBy, af.last_modified_date as attachedFileLastModifiedDate
        FROM owl_project p
            RIGHT JOIN owl_project_shared_attached_file psaf ON p.id = psaf.project_id
            LEFT JOIN owl_attached_file af ON psaf.attached_file_id = af.id
        WHERE 1=1
        <if test="projectIds != null">
            AND p.id IN
            <foreach item="item" index="index" collection="projectIds"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        UNION ALL
        SELECT t.name as location, 'TASK' as locationType, t.id as locationId
            , af.id as attachedFileId, af.name as attachedFileName
            , af.size as attachedFileSize, af.content_type as attachedFileContentType
            , af.created_by as attachedFileCreatedBy, af.created_date as attachedFileCreatedDate
            , af.last_modified_by as attachedFileLastModifiedBy, af.last_modified_date as attachedFileLastModifiedDate
        FROM owl_task t
            RIGHT JOIN owl_task_project tp ON tp.task_id = t.id
            RIGHT JOIN owl_task_attached_file taf ON t.id = taf.task_id
            LEFT JOIN owl_attached_file af ON taf.attached_file_id = af.id
        WHERE 1=1
        <if test="projectIds != null">
            AND tp.project_id IN
            <foreach item="item" index="index" collection="projectIds"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        UNION ALL
        SELECT t.name as location, 'TASK_REPLY' as locationType, t.id as locationId
            , af.id as attachedFileId, af.name as attachedFileName
            , af.size as attachedFileSize, af.content_type as attachedFileContentType
            , af.created_by as attachedFileCreatedBy, af.created_date as attachedFileCreatedDate
            , af.last_modified_by as attachedFileLastModifiedBy, af.last_modified_date as attachedFileLastModifiedDate
        FROM owl_trace_log tl
            LEFT OUTER JOIN owl_task t ON tl.task_id = t.id
            RIGHT JOIN owl_trace_log_attached_file tlaf ON tl.id = tlaf.trace_log_id
            LEFT JOIN owl_attached_file af ON tlaf.attached_file_id = af.id
        WHERE tl.task_id IN (
            SELECT it.id
            FROM owl_task it
            RIGHT JOIN owl_task_project itp ON itp.task_id = it.id
            WHERE 1=1
            <if test="projectIds != null">
                AND itp.project_id IN
                <foreach item="item" index="index" collection="projectIds"
                         open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        )
        AND tl.reply_yn = 'Y'
        UNION ALL
        SELECT p.name as location, 'PROJECT_REPLY' as locationType, p.id as locationId
            , af.id as attachedFileId, af.name as attachedFileName
            , af.size as attachedFileSize, af.content_type as attachedFileContentType
            , af.created_by as attachedFileCreatedBy, af.created_date as attachedFileCreatedDate
            , af.last_modified_by as attachedFileLastModifiedBy, af.last_modified_date as attachedFileLastModifiedDate
        FROM owl_trace_log tl
            LEFT OUTER JOIN owl_project p ON tl.project_id = p.id
            RIGHT JOIN owl_trace_log_attached_file tlaf ON tl.id = tlaf.trace_log_id
            LEFT JOIN owl_attached_file af ON tlaf.attached_file_id = af.id
        WHERE 1=1
        <if test="projectIds != null">
            AND tl.project_id IN
            <foreach item="item" index="index" collection="projectIds"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND tl.reply_yn = 'Y'
    </select>

</mapper>
